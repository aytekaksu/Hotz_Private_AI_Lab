# AI Assistant - Deployment Guide

This guide will help you deploy the AI Assistant application on your VPS.

## Prerequisites

- VPS with Ubuntu 20.04+ or similar Linux distribution
- Docker and Docker Compose installed
- Domain name with DNS control (for Caddy TLS)
- WireGuard VPN configured (optional but recommended for security)

## Quick Start

### 1. Initial Setup

Run the setup script to generate encryption keys and create necessary directories:

```bash
./scripts/setup.sh
```

### 2. Configure Environment Variables

Edit the `.env` file and fill in the required values:

```bash
nano .env
```

Required values:
- `GOOGLE_CLIENT_ID` - From Google Cloud Console
- `GOOGLE_CLIENT_SECRET` - From Google Cloud Console
- `NOTION_CLIENT_ID` - From Notion Integrations page
- `NOTION_CLIENT_SECRET` - From Notion Integrations page
- `CLOUDFLARE_API_TOKEN` - If using Cloudflare for DNS-01 challenge
- `INTERNAL_DOMAIN` - Your internal domain (e.g., assistant.internal.yourdomain.com)
- `NEXTAUTH_URL` - Should be https://your-domain (e.g., https://assistant.internal.yourdomain.com)

The following are auto-generated by setup.sh:
- `APP_ENCRYPTION_KEY`
- `N8N_ENCRYPTION_KEY`
- `NEXTAUTH_SECRET`

### 3. Install Dependencies

```bash
cd apps/web
npm install
cd ../..
```

### 4. Initialize Database

```bash
cd apps/web
npm run db:migrate
cd ../..
```

### 5. Build and Start Services

For production with Docker:

```bash
docker compose up -d
```

For development:

```bash
cd apps/web
npm run dev
```

### 6. Access the Application

- Main app: `https://your-domain` (e.g., https://assistant.internal.yourdomain.com)
- n8n UI: `https://n8n.your-domain` (e.g., https://n8n.assistant.internal.yourdomain.com)

### 7. Configure n8n Workflows

1. Access the n8n UI
2. Import the workflow JSON files from `apps/n8n/workflows/`
3. Configure credentials:
   - Google Calendar OAuth2
   - Google Tasks OAuth2
   - Notion API

## OAuth Setup

### Google Cloud Console

1. Create a new project or select an existing one
2. Enable Google Calendar API and Google Tasks API
3. Create OAuth 2.0 credentials
4. Add authorized redirect URIs:
   - `https://your-domain/api/auth/google/callback`
5. Copy Client ID and Client Secret to `.env`

### Notion

1. Go to https://www.notion.so/my-integrations
2. Create a new integration
3. Add redirect URI:
   - `https://your-domain/api/auth/notion/callback`
4. Copy Client ID and Client Secret to `.env`

## Backup & Restore

### Create Backup

```bash
./scripts/backup.sh
```

Backups are stored in `/opt/backups/ai-assistant/` and kept for 7 days.

### Restore from Backup

```bash
./scripts/restore.sh /path/to/backup_TIMESTAMP.tar.gz
```

### Automated Backups

Set up a cron job for daily backups:

```bash
crontab -e
```

Add:

```
0 2 * * * /opt/ai-assistant/scripts/backup.sh >> /var/log/ai-assistant-backup.log 2>&1
```

## Security Considerations

### VPN Access (Recommended)

For maximum security, set up WireGuard VPN and configure your firewall to only allow access through the VPN:

```bash
# Allow only VPN subnet
ufw allow from 10.0.0.0/24 to any port 443
ufw deny 443
```

### Encryption

All sensitive data (API keys, OAuth tokens) is encrypted at rest using AES-256-GCM.

### HTTPS

Caddy automatically obtains and renews TLS certificates using DNS-01 challenge.

## Monitoring

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f web
docker compose logs -f n8n

# Last 100 lines
docker compose logs --tail=100 web
```

### Health Check

Access the health endpoint:

```bash
curl https://your-domain/api/health
```

## Troubleshooting

### Database Issues

If you encounter database lock errors:

```bash
# Stop services
docker compose down

# Remove database lock files
rm data/sqlite/*.db-shm data/sqlite/*.db-wal

# Restart
docker compose up -d
```

### OAuth Issues

1. Verify redirect URIs match exactly in Google/Notion console
2. Check that `NEXTAUTH_URL` is set correctly
3. Ensure HTTPS is working (check Caddy logs)

### n8n Workflow Issues

1. Check n8n logs: `docker compose logs n8n`
2. Verify credentials are configured in n8n UI
3. Test workflows manually in n8n before using from chat

### Connection Issues

1. Verify VPN is connected (if using)
2. Check DNS resolution: `nslookup your-domain`
3. Verify Caddy is running: `docker compose ps caddy`

## Updating

To update the application:

```bash
# Pull latest changes
git pull

# Rebuild containers
docker compose down
docker compose up -d --build
```

## Support

For issues and questions, refer to the main README.md file or create an issue in the repository.



